#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
äº§å“åˆ†æå·¥å…·

æ­¤è„šæœ¬ç”¨äºåˆ†æäº§å“æ¦œå•ï¼Œæ”¯æŒä½¿ç”¨DeepSeekå’ŒOpenAIä¸¤ç§APIï¼Œé»˜è®¤ä½¿ç”¨DeepSeekã€‚

ä½¿ç”¨æ–¹æ³•:
    python analyze_product.py --rank 460 --api deepseek  # ä½¿ç”¨DeepSeekåˆ†ææ’å460çš„äº§å“
    python analyze_product.py --rank 460 --api openai    # ä½¿ç”¨OpenAIåˆ†ææ’å460çš„äº§å“
"""

import os
import sys
import argparse
import pandas as pd
import time
import json
import traceback
from datetime import datetime
import re
import requests
import glob
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# è·å–APIå¯†é’¥
OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY")
DEEPSEEK_API_KEY = os.environ.get("DEEPSEEK_API_KEY")

# åˆ†ææ¡†æ¶æ¨¡æ¿
ANALYSIS_FRAMEWORK_CN = """
## äº§å“ä¿¡æ¯

ğŸ“Š æ’å: {rank}

ğŸ’° æ”¶å…¥: {revenue}

ğŸ”— äº§å“é“¾æ¥: [{domain}](https://{domain})

ğŸ” åˆ†æé“¾æ¥: [toolify.ai/tool/{safe_domain}](https://www.toolify.ai/tool/{safe_domain})

ğŸ‘€ æœˆè®¿é—®é‡: {monthly_visits}

ğŸ¢ å…¬å¸: {company}

ğŸ—“ï¸ æˆç«‹æ—¥æœŸ: {founded_year}

ğŸ’² å®šä»·: {pricing}

ğŸ“± å¹³å°: {platform}

ğŸ”§ æ ¸å¿ƒåŠŸèƒ½: {features}

ğŸŒ åº”ç”¨åœºæ™¯: {use_cases}

â±ï¸ åˆ†ææ—¶é—´: {current_date}

ğŸ¤– åˆ†æå·¥å…·: {api_name}

## äº§å“åˆ†ææ¡†æ¶

ğŸ’¡ è¿™ä¸ªäº§å“è§£å†³çš„æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Ÿ

ğŸ‘¤ ç”¨æˆ·æ˜¯è°ï¼Ÿ

ğŸ¤” ç”¨æˆ·ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ

ğŸ—£ï¸ ç”¨æˆ·æ˜¯å¦‚ä½•è¯„ä»·å®ƒçš„ï¼Ÿ

ğŸ” å®ƒæ˜¯å¦‚ä½•æ‰¾åˆ°ç”¨æˆ·çš„ï¼Ÿ

ğŸ’° å®ƒèµšé’±å—ï¼Ÿå¤šå°‘ï¼Ÿ

ğŸ§  æˆ‘ä»è¿™ä¸ªäº§å“èº«ä¸Šå­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ

ğŸ¤” å®ƒçš„ä»€ä¹ˆåšæ³•ä¸å®¹æ˜“ï¼Ÿ

ğŸ¤— ä¸€å¥è¯æ¨é”€ï¼š

ğŸ’¡ ä¸åŒçš„æ–¹æ³•ï¼š

ğŸ‰ æˆ‘èƒ½åšå‡ºæ¥å—ï¼Ÿ

ğŸ§­ å¦‚ä½•æ‰¾åˆ°ç”¨æˆ·ï¼Ÿ

ğŸ¤” ä¸ºä»€ä¹ˆæ˜¯æˆ‘ï¼Ÿ

â¤ï¸ æˆ‘èƒ½åšæŒå—ï¼Ÿ

## SWOTåˆ†æ

| ä¼˜åŠ¿(Strengths) | åŠ£åŠ¿(Weaknesses) |
|----------------|----------------|
| â€¢ ä¼˜åŠ¿1 | â€¢ åŠ£åŠ¿1 |
| â€¢ ä¼˜åŠ¿2 | â€¢ åŠ£åŠ¿2 |
| â€¢ ä¼˜åŠ¿3 | â€¢ åŠ£åŠ¿3 |

| æœºä¼š(Opportunities) | å¨èƒ(Threats) |
|-------------------|------------|
| â€¢ æœºä¼š1 | â€¢ å¨èƒ1 |
| â€¢ æœºä¼š2 | â€¢ å¨èƒ2 |
| â€¢ æœºä¼š3 | â€¢ å¨èƒ3 |

## è¯„åˆ†ä½“ç³»

åˆ›æ–°æ€§ï¼š7/10

å•†ä¸šæ¨¡å¼å¯è¡Œæ€§ï¼š6/10

å¢é•¿æ½œåŠ›ï¼š8/10

æ€»åˆ†ï¼š7/10

## å…³é”®æ´å¯Ÿä¸å»ºè®®

å¯æ‰§è¡Œæ´å¯Ÿï¼š

1. æ´å¯Ÿ1
2. æ´å¯Ÿ2
3. æ´å¯Ÿ3

ç»éªŒæ•™è®­ï¼š

- æ•™è®­1
- æ•™è®­2
- æ•™è®­3

å¸‚åœºå·®å¼‚åŒ–å»ºè®®ï¼š

- å»ºè®®1
- å»ºè®®2
- å»ºè®®3
"""

# English analysis framework template
ANALYSIS_FRAMEWORK_EN = """
## Product Information

ğŸ“Š Rank: {rank}

ğŸ’° Revenue: {revenue}

ğŸ”— Product Link: [{domain}](https://{domain})

ğŸ” Analysis Link: [toolify.ai/tool/{safe_domain}](https://www.toolify.ai/tool/{safe_domain})

ğŸ‘€ Monthly Visits: {monthly_visits}

ğŸ¢ Company: {company}

ğŸ—“ï¸ Founded: {founded_year}

ğŸ’² Pricing: {pricing}

ğŸ“± Platform: {platform}

ğŸ”§ Core Features: {features}

ğŸŒ Use Cases: {use_cases}

â±ï¸ Analysis Date: {current_date}

ğŸ¤– Analysis Tool: {api_name}

## Product Analysis Framework

ğŸ’¡ What problem does this product solve?

ğŸ‘¤ Who are the users?

ğŸ¤” Why do users need it?

ğŸ—£ï¸ How do users review it?

ğŸ” How does it find users?

ğŸ’° Does it make money? How much?

ğŸ§  What have I learned from this product?

ğŸ¤” What aspects of it are difficult to implement?

ğŸ¤— One-line pitch:

ğŸ’¡ Different approaches:

ğŸ‰ Can I build it?

ğŸ§­ How to find users?

ğŸ¤” Why me?

â¤ï¸ Can I persist?

## SWOT Analysis

| Strengths | Weaknesses |
|----------------|----------------|
| â€¢ Strength 1 | â€¢ Weakness 1 |
| â€¢ Strength 2 | â€¢ Weakness 2 |
| â€¢ Strength 3 | â€¢ Weakness 3 |

| Opportunities | Threats |
|-------------------|------------|
| â€¢ Opportunity 1 | â€¢ Threat 1 |
| â€¢ Opportunity 2 | â€¢ Threat 2 |
| â€¢ Opportunity 3 | â€¢ Threat 3 |

## Rating System

Innovation: 7/10

Business Model Viability: 6/10

Growth Potential: 8/10

Overall Score: 7/10

## Key Insights and Recommendations

Actionable Insights:

1. Insight 1
2. Insight 2
3. Insight 3

Lessons Learned:

- Lesson 1
- Lesson 2
- Lesson 3

Market Differentiation Recommendations:

- Recommendation 1
- Recommendation 2
- Recommendation 3
"""

def get_current_date_str():
    """è·å–å½“å‰æ—¥æœŸå­—ç¬¦ä¸²ï¼Œæ ¼å¼ä¸ºYYYYMMDD"""
    return datetime.now().strftime("%Y%m%d")

def find_data_file(base_dir="output", language="cn", date_str=None):
    """
    æŸ¥æ‰¾æ•°æ®æ–‡ä»¶

    Args:
        base_dir (str): åŸºç¡€ç›®å½•
        language (str): è¯­è¨€ï¼Œ"cn"æˆ–"en"
        date_str (str, optional): æ—¥æœŸå­—ç¬¦ä¸²ï¼Œå¦‚æœä¸æä¾›åˆ™ä½¿ç”¨å½“å‰æ—¥æœŸ

    Returns:
        str: æ•°æ®æ–‡ä»¶è·¯å¾„
    """
    if date_str is None:
        date_str = get_current_date_str()

    # å°è¯•åœ¨å¤šä¸ªå¯èƒ½çš„ä½ç½®æŸ¥æ‰¾æ–‡ä»¶
    possible_locations = [
        # æ ‡å‡†ä½ç½®
        os.path.join(base_dir, "toolify_data"),
        # æ–°ä½ç½®
        os.path.join(base_dir, "toolify_data", f"toolify_analysis_{date_str}"),
        # å…¶ä»–å¯èƒ½çš„ä½ç½®
        os.path.join(base_dir),
        os.path.join(".", "output", "toolify_data"),
        os.path.join(".", "output", "toolify_data", f"toolify_analysis_{date_str}")
    ]

    # å°è¯•ä¸åŒçš„æ–‡ä»¶åæ¨¡å¼
    file_patterns = [
        f"*{language.upper()}*{date_str}*.xlsx",  # ç²¾ç¡®åŒ¹é…
        f"Toolify_AI_Revenue_{language.upper()}_{date_str}.xlsx",  # æ ‡å‡†å‘½å
        f"Toolify_Top_AI_Revenue_Rankings_{language.upper()}_{date_str}.xlsx",  # å¦ä¸€ç§å‘½å
        f"*{language.upper()}*.xlsx"  # æ¨¡ç³ŠåŒ¹é…
    ]

    # åœ¨æ‰€æœ‰å¯èƒ½çš„ä½ç½®å’Œæ¨¡å¼ä¸­æŸ¥æ‰¾
    for location in possible_locations:
        if not os.path.exists(location):
            continue

        print(f"[INFO] åœ¨ {location} ä¸­æŸ¥æ‰¾æ•°æ®æ–‡ä»¶...")

        for pattern in file_patterns:
            matching_files = glob.glob(os.path.join(location, pattern))

            if matching_files:
                # æŒ‰ä¿®æ”¹æ—¶é—´æ’åºï¼Œé€‰æ‹©æœ€æ–°çš„æ–‡ä»¶
                matching_files.sort(key=os.path.getmtime, reverse=True)
                print(f"[INFO] æ‰¾åˆ°æ•°æ®æ–‡ä»¶: {matching_files[0]}")
                return matching_files[0]

    # å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œå°è¯•åœ¨å½“å‰ç›®å½•ä¸‹æŸ¥æ‰¾
    for pattern in file_patterns:
        matching_files = glob.glob(pattern)
        if matching_files:
            matching_files.sort(key=os.path.getmtime, reverse=True)
            print(f"[INFO] åœ¨å½“å‰ç›®å½•ä¸‹æ‰¾åˆ°æ•°æ®æ–‡ä»¶: {matching_files[0]}")
            return matching_files[0]

    print(f"[ERROR] æœªæ‰¾åˆ°{language.upper()}æ•°æ®æ–‡ä»¶")
    return None

def analyze_product_with_openai(product, api_key, language="cn"):
    """
    ä½¿ç”¨OpenAI APIåˆ†æäº§å“

    Args:
        product (dict): äº§å“æ•°æ®
        api_key (str): OpenAI APIå¯†é’¥
        language (str): è¯­è¨€ï¼Œ"cn"æˆ–"en"

    Returns:
        str: åˆ†æå†…å®¹
    """
    if not api_key:
        print("[ERROR] æœªæ‰¾åˆ°OpenAI APIå¯†é’¥ï¼Œè¯·è®¾ç½®ç¯å¢ƒå˜é‡OPENAI_API_KEY")
        return None

    # ä»äº§å“æ•°æ®ä¸­æå–ä¿¡æ¯
    name = product.get("Tool Name") or product.get("å·¥å…·åç§°", "æœªçŸ¥")
    rank = product.get("Rank") or product.get("æ’å", "æœªçŸ¥")
    revenue = product.get("Revenue") or product.get("æ”¶å…¥", "æœªçŸ¥")

    # ä½¿ç”¨Cåˆ—ä½œä¸ºäº§å“é“¾æ¥ï¼ŒDåˆ—ä½œä¸ºäº§å“ç½‘å€
    tool_link = product.get("C") or product.get("å·¥å…·é“¾æ¥", "æœªçŸ¥")
    website = product.get("D") or product.get("ç½‘ç«™", "æœªçŸ¥")

    monthly_visits = product.get("Monthly Visits") or product.get("æœˆè®¿é—®é‡", "æœªçŸ¥")
    company = product.get("Company") or product.get("å…¬å¸", "æœªçŸ¥")
    founded_year = product.get("Founded Year") or product.get("æˆç«‹å¹´ä»½", "æœªçŸ¥")
    pricing = product.get("Payment Platform") or product.get("å®šä»·", "æœªçŸ¥")
    features = product.get("Features") or product.get("åŠŸèƒ½ç‰¹æ€§", "æœªçŸ¥")
    use_cases = product.get("Use Cases") or product.get("åº”ç”¨åœºæ™¯", "æœªçŸ¥")
    description = product.get("Description") or product.get("æè¿°", "æœªçŸ¥")

    # ç¡®ä¿æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„åŸŸå
    # å¦‚æœæ²¡æœ‰è·å–åˆ°é“¾æ¥ä¿¡æ¯ï¼Œä½¿ç”¨äº§å“åç§°ç”ŸæˆåŸŸå
    domain = name.lower().replace(' ', '').replace('-', '').replace('_', '') + '.com'
    safe_domain = domain.replace('.', '-')

    # å‡†å¤‡æ¨¡æ¿æ•°æ®
    current_date = datetime.now().strftime('%Y-%m-%d') if language == "en" else datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')
    platform = 'Web, Mobile Web' if language == "en" else 'ç½‘é¡µã€ç§»åŠ¨ç½‘é¡µ' if website else 'æœªçŸ¥'

    # é€‰æ‹©æ¨¡æ¿
    template = ANALYSIS_FRAMEWORK_EN if language == "en" else ANALYSIS_FRAMEWORK_CN

    # å¡«å……æ¨¡æ¿
    template = template.format(
        rank=rank,
        revenue=revenue,
        domain=domain,
        safe_domain=safe_domain,
        monthly_visits=monthly_visits,
        company=company,
        founded_year=founded_year,
        pricing=pricing,
        platform=platform,
        features=features,
        use_cases=use_cases,
        current_date=current_date,
        api_name="OpenAI GPT-4"
    )

    # å‡†å¤‡æç¤ºè¯­
    if language == "en":
        prompt = f"""Please provide a comprehensive analysis of the following product, filling in the template directly. Do not change the format or structure of the template.

Product Name: {name}
Product Description: {description}
Product Link: {website}

Please note the following requirements:
1. Maintain all link formats in the template, such as [domain.com](https://www.domain.com)
2. The analysis date should be the current date: {current_date}
3. The analysis tool should be OpenAI GPT-4
4. Do not use arrow symbols (â†’), write out the content directly
5. Each answer should be concise and clear, not overly verbose
6. Fill in specific strengths, weaknesses, opportunities, and threats in the SWOT analysis
7. Provide specific scores in the rating system, such as 8/10
8. Do not add separators (---) or other additional formatting elements
9. Do not add bold or other formatting to headings, maintain the original style
10. Do not add asterisks (*), double asterisks (**), backticks (`), or other special symbols in the text
11. Do not add spaces or special symbols at the end of text lines
12. Do not use bold, italic, underline, or other formatting, maintain plain text format
13. In the Product Analysis Framework section, answer the questions directly without adding additional markers
14. The Key Insights and Recommendations section should be divided into Actionable Insights, Lessons Learned, and Market Differentiation Recommendations as per the template

Please fill in the content directly in the following template, maintaining the format unchanged:

{template}
"""
    else:
        prompt = f"""è¯·å¯¹ä»¥ä¸‹äº§å“è¿›è¡Œå…¨é¢åˆ†æï¼Œå¹¶ç›´æ¥åœ¨æ¨¡æ¿ä¸­å¡«å……å†…å®¹ã€‚ä¸è¦æ”¹å˜æ¨¡æ¿çš„æ ¼å¼å’Œç»“æ„ã€‚

äº§å“åç§°: {name}
äº§å“æè¿°: {description}
äº§å“é“¾æ¥: {website}

è¯·æ³¨æ„ä»¥ä¸‹è¦æ±‚ï¼š
1. ä¿ç•™æ¨¡æ¿ä¸­çš„æ‰€æœ‰é“¾æ¥æ ¼å¼ï¼Œå¦‚ [domain.com](https://www.domain.com)
2. åˆ†ææ—¶é—´åº”ä¸ºå½“å‰æ—¥æœŸï¼š{current_date}
3. åˆ†æå·¥å…·åº”ä¸º OpenAI GPT-4
4. ä¸è¦ä½¿ç”¨ç®­å¤´ç¬¦å·ï¼ˆâ†’ï¼‰ï¼Œç›´æ¥å†™å‡ºå†…å®¹
5. æ¯ä¸ªé—®é¢˜çš„å›ç­”åº”è¯¥ç®€æ´æ¸…æ™°ï¼Œä¸è¦è¿‡äºå†—é•¿
6. åœ¨SWOTåˆ†æä¸­å¡«å†™å…·ä½“çš„ä¼˜åŠ¿ã€åŠ£åŠ¿ã€æœºä¼šå’Œå¨èƒ
7. åœ¨è¯„åˆ†ä½“ç³»ä¸­ç»™å‡ºå…·ä½“çš„åˆ†æ•°ï¼Œå¦‚ 8/10
8. ä¸è¦æ·»åŠ åˆ†éš”çº¿ï¼ˆ---ï¼‰æˆ–å…¶ä»–é¢å¤–çš„æ ¼å¼å…ƒç´ 
9. ä¸è¦åœ¨æ ‡é¢˜å‰æ·»åŠ åŠ ç²—æˆ–å…¶ä»–æ ¼å¼ï¼Œä¿æŒåŸæ ·å¼
10. ä¸è¦åœ¨æ–‡æœ¬ä¸­æ·»åŠ æ˜Ÿå·ï¼ˆ*ï¼‰ã€åŒæ˜Ÿå·ï¼ˆ**ï¼‰ã€åå¼•å·ï¼ˆ`ï¼‰ç­‰ç‰¹æ®Šç¬¦å·
11. ä¸è¦åœ¨æ–‡æœ¬è¡Œæœ«æ·»åŠ ç©ºæ ¼æˆ–ç‰¹æ®Šç¬¦å·
12. ä¸è¦ä½¿ç”¨åŠ ç²—ã€æ–œä½“ã€ä¸‹åˆ’çº¿ç­‰æ ¼å¼ï¼Œä¿æŒçº¯æ–‡æœ¬æ ¼å¼
13. åœ¨äº§å“åˆ†ææ¡†æ¶éƒ¨åˆ†ï¼Œç›´æ¥å›ç­”é—®é¢˜ï¼Œä¸è¦æ·»åŠ "è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ**"ã€"ç›®æ ‡ç”¨æˆ·ï¼š**"ç­‰é¢å¤–çš„æ ‡è®°
14. å…³é”®æ´å¯Ÿä¸å»ºè®®éƒ¨åˆ†åº”è¯¥æŒ‰ç…§æ¨¡æ¿ä¸­çš„æ ¼å¼ç»†åˆ†ä¸ºå¯æ‰§è¡Œæ´å¯Ÿã€ç»éªŒæ•™è®­å’Œå¸‚åœºå·®å¼‚åŒ–å»ºè®®ä¸‰éƒ¨åˆ†

è¯·åœ¨ä»¥ä¸‹æ¨¡æ¿ä¸­ç›´æ¥å¡«å……å†…å®¹ï¼Œä¿æŒæ¨¡æ¿çš„æ ¼å¼ä¸å˜ï¼š

{template}
"""

    # è°ƒç”¨OpenAI API
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Content-Type": "application/json"
    }

    data = {
        "model": "gpt-4",
        "messages": [
            {"role": "user", "content": prompt}
        ],
        "temperature": 0.7,
        "max_tokens": 4000
    }

    try:
        print("[INFO] æ­£åœ¨è°ƒç”¨OpenAI API...")
        response = requests.post(
            "https://api.openai.com/v1/chat/completions",
            headers=headers,
            json=data,
            timeout=120
        )

        if response.status_code == 200:
            result = response.json()
            analysis_content = result["choices"][0]["message"]["content"]

            # å¤„ç†å¤šä½™çš„ç©ºè¡Œ
            analysis_content = re.sub(r'\n{3,}', '\n\n', analysis_content)

            # æ·»åŠ æ ‡é¢˜
            markdown_content = f"# {name}\n\n{analysis_content}"

            return markdown_content
        else:
            print(f"[ERROR] OpenAI APIè°ƒç”¨å¤±è´¥: {response.status_code} - {response.text}")
            return None
    except Exception as e:
        print(f"[ERROR] è°ƒç”¨OpenAI APIæ—¶å‡ºé”™: {str(e)}")
        return None

def analyze_product_with_deepseek(product, api_key, language="cn"):
    """
    ä½¿ç”¨DeepSeek APIåˆ†æäº§å“

    Args:
        product (dict): äº§å“æ•°æ®
        api_key (str): DeepSeek APIå¯†é’¥
        language (str): è¯­è¨€ï¼Œ"cn"æˆ–"en"

    Returns:
        str: åˆ†æå†…å®¹
    """
    if not api_key:
        print("[ERROR] æœªæ‰¾åˆ°DeepSeek APIå¯†é’¥ï¼Œè¯·è®¾ç½®ç¯å¢ƒå˜é‡DEEPSEEK_API_KEY")
        return None

    # ä»äº§å“æ•°æ®ä¸­æå–ä¿¡æ¯
    name = product.get("Tool Name") or product.get("å·¥å…·åç§°", "æœªçŸ¥")
    rank = product.get("Rank") or product.get("æ’å", "æœªçŸ¥")
    revenue = product.get("Revenue") or product.get("æ”¶å…¥", "æœªçŸ¥")

    # ä½¿ç”¨Cåˆ—ä½œä¸ºäº§å“é“¾æ¥ï¼ŒDåˆ—ä½œä¸ºäº§å“ç½‘å€
    tool_link = product.get("C") or product.get("å·¥å…·é“¾æ¥", "æœªçŸ¥")
    website = product.get("D") or product.get("ç½‘ç«™", "æœªçŸ¥")

    monthly_visits = product.get("Monthly Visits") or product.get("æœˆè®¿é—®é‡", "æœªçŸ¥")
    company = product.get("Company") or product.get("å…¬å¸", "æœªçŸ¥")
    founded_year = product.get("Founded Year") or product.get("æˆç«‹å¹´ä»½", "æœªçŸ¥")
    pricing = product.get("Payment Platform") or product.get("å®šä»·", "æœªçŸ¥")
    features = product.get("Features") or product.get("åŠŸèƒ½ç‰¹æ€§", "æœªçŸ¥")
    use_cases = product.get("Use Cases") or product.get("åº”ç”¨åœºæ™¯", "æœªçŸ¥")
    description = product.get("Description") or product.get("æè¿°", "æœªçŸ¥")

    # ç¡®ä¿æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„åŸŸå
    # å¦‚æœæ²¡æœ‰è·å–åˆ°é“¾æ¥ä¿¡æ¯ï¼Œä½¿ç”¨äº§å“åç§°ç”ŸæˆåŸŸå
    domain = name.lower().replace(' ', '').replace('-', '').replace('_', '') + '.com'
    safe_domain = domain.replace('.', '-')

    # å‡†å¤‡æ¨¡æ¿æ•°æ®
    current_date = datetime.now().strftime('%Y-%m-%d') if language == "en" else datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')
    platform = 'Web, Mobile Web' if language == "en" else 'ç½‘é¡µã€ç§»åŠ¨ç½‘é¡µ' if website else 'æœªçŸ¥'

    # é€‰æ‹©æ¨¡æ¿
    template = ANALYSIS_FRAMEWORK_EN if language == "en" else ANALYSIS_FRAMEWORK_CN

    # å¡«å……æ¨¡æ¿
    template = template.format(
        rank=rank,
        revenue=revenue,
        domain=domain,
        safe_domain=safe_domain,
        monthly_visits=monthly_visits,
        company=company,
        founded_year=founded_year,
        pricing=pricing,
        platform=platform,
        features=features,
        use_cases=use_cases,
        current_date=current_date,
        api_name="DeepSeek AI"
    )

    # å‡†å¤‡æç¤ºè¯­
    if language == "en":
        prompt = f"""Please provide a comprehensive analysis of the following product, filling in the template directly. Do not change the format or structure of the template.

Product Name: {name}
Product Description: {description}
Product Link: {website}

Please note the following requirements:
1. Maintain all link formats in the template, such as [domain.com](https://www.domain.com)
2. The analysis date should be the current date: {current_date}
3. The analysis tool should be DeepSeek AI
4. Do not use arrow symbols (â†’), write out the content directly
5. Each answer should be concise and clear, not overly verbose
6. Fill in specific strengths, weaknesses, opportunities, and threats in the SWOT analysis
7. Provide specific scores in the rating system, such as 8/10
8. Do not add separators (---) or other additional formatting elements
9. Do not add bold or other formatting to headings, maintain the original style
10. Do not add asterisks (*), double asterisks (**), backticks (`), or other special symbols in the text
11. Do not add spaces or special symbols at the end of text lines
12. Do not use bold, italic, underline, or other formatting, maintain plain text format
13. In the Product Analysis Framework section, answer the questions directly without adding additional markers
14. The Key Insights and Recommendations section should be divided into Actionable Insights, Lessons Learned, and Market Differentiation Recommendations as per the template

Please fill in the content directly in the following template, maintaining the format unchanged:

{template}
"""
    else:
        prompt = f"""è¯·å¯¹ä»¥ä¸‹äº§å“è¿›è¡Œå…¨é¢åˆ†æï¼Œå¹¶ç›´æ¥åœ¨æ¨¡æ¿ä¸­å¡«å……å†…å®¹ã€‚ä¸è¦æ”¹å˜æ¨¡æ¿çš„æ ¼å¼å’Œç»“æ„ã€‚

äº§å“åç§°: {name}
äº§å“æè¿°: {description}
äº§å“é“¾æ¥: {website}

è¯·æ³¨æ„ä»¥ä¸‹è¦æ±‚ï¼š
1. ä¿ç•™æ¨¡æ¿ä¸­çš„æ‰€æœ‰é“¾æ¥æ ¼å¼ï¼Œå¦‚ [domain.com](https://www.domain.com)
2. åˆ†ææ—¶é—´åº”ä¸ºå½“å‰æ—¥æœŸï¼š{current_date}
3. åˆ†æå·¥å…·åº”ä¸º DeepSeek AI
4. ä¸è¦ä½¿ç”¨ç®­å¤´ç¬¦å·ï¼ˆâ†’ï¼‰ï¼Œç›´æ¥å†™å‡ºå†…å®¹
5. æ¯ä¸ªé—®é¢˜çš„å›ç­”åº”è¯¥ç®€æ´æ¸…æ™°ï¼Œä¸è¦è¿‡äºå†—é•¿
6. åœ¨SWOTåˆ†æä¸­å¡«å†™å…·ä½“çš„ä¼˜åŠ¿ã€åŠ£åŠ¿ã€æœºä¼šå’Œå¨èƒ
7. åœ¨è¯„åˆ†ä½“ç³»ä¸­ç»™å‡ºå…·ä½“çš„åˆ†æ•°ï¼Œå¦‚ 8/10
8. ä¸è¦æ·»åŠ åˆ†éš”çº¿ï¼ˆ---ï¼‰æˆ–å…¶ä»–é¢å¤–çš„æ ¼å¼å…ƒç´ 
9. ä¸è¦åœ¨æ ‡é¢˜å‰æ·»åŠ åŠ ç²—æˆ–å…¶ä»–æ ¼å¼ï¼Œä¿æŒåŸæ ·å¼
10. ä¸è¦åœ¨æ–‡æœ¬ä¸­æ·»åŠ æ˜Ÿå·ï¼ˆ*ï¼‰ã€åŒæ˜Ÿå·ï¼ˆ**ï¼‰ã€åå¼•å·ï¼ˆ`ï¼‰ç­‰ç‰¹æ®Šç¬¦å·
11. ä¸è¦åœ¨æ–‡æœ¬è¡Œæœ«æ·»åŠ ç©ºæ ¼æˆ–ç‰¹æ®Šç¬¦å·
12. ä¸è¦ä½¿ç”¨åŠ ç²—ã€æ–œä½“ã€ä¸‹åˆ’çº¿ç­‰æ ¼å¼ï¼Œä¿æŒçº¯æ–‡æœ¬æ ¼å¼
13. åœ¨äº§å“åˆ†ææ¡†æ¶éƒ¨åˆ†ï¼Œç›´æ¥å›ç­”é—®é¢˜ï¼Œä¸è¦æ·»åŠ "è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ**"ã€"ç›®æ ‡ç”¨æˆ·ï¼š**"ç­‰é¢å¤–çš„æ ‡è®°
14. å…³é”®æ´å¯Ÿä¸å»ºè®®éƒ¨åˆ†åº”è¯¥æŒ‰ç…§æ¨¡æ¿ä¸­çš„æ ¼å¼ç»†åˆ†ä¸ºå¯æ‰§è¡Œæ´å¯Ÿã€ç»éªŒæ•™è®­å’Œå¸‚åœºå·®å¼‚åŒ–å»ºè®®ä¸‰éƒ¨åˆ†

è¯·åœ¨ä»¥ä¸‹æ¨¡æ¿ä¸­ç›´æ¥å¡«å……å†…å®¹ï¼Œä¿æŒæ¨¡æ¿çš„æ ¼å¼ä¸å˜ï¼š

{template}
"""

    # è°ƒç”¨DeepSeek API
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Content-Type": "application/json"
    }

    data = {
        "model": "deepseek-chat",
        "messages": [
            {"role": "user", "content": prompt}
        ],
        "temperature": 0.7,
        "max_tokens": 4000
    }

    try:
        print("[INFO] æ­£åœ¨è°ƒç”¨DeepSeek API...")
        response = requests.post(
            "https://api.deepseek.com/v1/chat/completions",
            headers=headers,
            json=data,
            timeout=120
        )

        if response.status_code == 200:
            result = response.json()
            analysis_content = result["choices"][0]["message"]["content"]

            # å¤„ç†å¤šä½™çš„ç©ºè¡Œ
            analysis_content = re.sub(r'\n{3,}', '\n\n', analysis_content)

            # æ·»åŠ æ ‡é¢˜
            markdown_content = f"# {name}\n\n{analysis_content}"

            return markdown_content
        else:
            print(f"[ERROR] DeepSeek APIè°ƒç”¨å¤±è´¥: {response.status_code} - {response.text}")
            return None
    except Exception as e:
        print(f"[ERROR] è°ƒç”¨DeepSeek APIæ—¶å‡ºé”™: {str(e)}")
        return None

def analyze_product(rank, api="deepseek", language="cn", date_str=None, base_dir="output"):
    """
    åˆ†ææŒ‡å®šæ’åçš„äº§å“

    Args:
        rank (int): äº§å“æ’å
        api (str): ä½¿ç”¨çš„APIï¼Œ"deepseek"æˆ–"openai"
        language (str): è¯­è¨€ï¼Œ"cn"æˆ–"en"
        date_str (str, optional): æ—¥æœŸå­—ç¬¦ä¸²ï¼Œå¦‚æœä¸æä¾›åˆ™ä½¿ç”¨å½“å‰æ—¥æœŸ
        base_dir (str): åŸºç¡€ç›®å½•

    Returns:
        bool: æ˜¯å¦æˆåŠŸ
    """
    if date_str is None:
        date_str = get_current_date_str()

    # æŸ¥æ‰¾æ•°æ®æ–‡ä»¶
    data_file = find_data_file(base_dir, language, date_str)
    if not data_file:
        return False

    # è¯»å–æ•°æ®æ–‡ä»¶
    try:
        df = pd.read_excel(data_file)
        products = df.to_dict('records')
        print(f"[INFO] å·²åŠ è½½ {len(products)} ä¸ªäº§å“æ•°æ®")
    except Exception as e:
        print(f"[ERROR] è¯»å–æ•°æ®æ–‡ä»¶æ—¶å‡ºé”™: {str(e)}")
        return False

    # æŸ¥æ‰¾å¯¹åº”æ’åçš„äº§å“
    product = None
    for p in products:
        p_rank = p.get("Rank") or p.get("æ’å")
        try:
            p_rank = int(p_rank)
        except (ValueError, TypeError):
            continue

        if p_rank == rank:
            product = p
            break

    if not product:
        print(f"[ERROR] æœªæ‰¾åˆ°æ’åä¸º {rank} çš„äº§å“")
        return False

    # è®¾ç½®è¾“å‡ºç›®å½•
    output_dir = os.path.join(base_dir, f"toolify_analysis_{date_str}", language, "markdown_files")
    os.makedirs(output_dir, exist_ok=True)

    # è·å–äº§å“åç§°
    product_name = product.get("Tool Name") or product.get("å·¥å…·åç§°", "æœªçŸ¥")
    safe_name = "".join([c if c.isalnum() else "_" for c in product_name.lower()])
    markdown_path = os.path.join(output_dir, f"{rank}-{safe_name}.md")

    print(f"[INFO] æ­£åœ¨åˆ†ææ’å {rank} çš„äº§å“: {product_name}")

    # æ ¹æ®é€‰æ‹©çš„APIåˆ†æäº§å“
    if api.lower() == "openai":
        markdown_content = analyze_product_with_openai(product, OPENAI_API_KEY, language)
    else:  # é»˜è®¤ä½¿ç”¨DeepSeek
        markdown_content = analyze_product_with_deepseek(product, DEEPSEEK_API_KEY, language)

    if markdown_content:
        # ä¿å­˜åˆ†æç»“æœ
        with open(markdown_path, 'w', encoding='utf-8') as f:
            f.write(markdown_content)

        print(f"[SUCCESS] å·²ä¿å­˜åˆ†æç»“æœåˆ° {markdown_path}")
        return True
    else:
        print(f"[ERROR] åˆ†ææ’å {rank} çš„äº§å“å¤±è´¥")
        return False

def main():
    """ä¸»å‡½æ•°"""
    parser = argparse.ArgumentParser(description='äº§å“åˆ†æå·¥å…·')
    parser.add_argument('--rank', type=int, required=True,
                        help='äº§å“æ’å')
    parser.add_argument('--api', choices=['deepseek', 'openai'], default='deepseek',
                        help='ä½¿ç”¨çš„APIï¼Œé»˜è®¤ä¸ºdeepseek')
    parser.add_argument('--language', choices=['cn', 'en'], default='cn',
                        help='è¯­è¨€ï¼Œ"cn"æˆ–"en"')
    parser.add_argument('--date', type=str, default=None,
                        help='æ—¥æœŸå­—ç¬¦ä¸²ï¼Œæ ¼å¼ä¸ºYYYYMMDDï¼Œé»˜è®¤ä¸ºå½“å‰æ—¥æœŸ')
    parser.add_argument('--base-dir', type=str, default='output',
                        help='åŸºç¡€ç›®å½•')

    args = parser.parse_args()

    # åˆ†æäº§å“
    success = analyze_product(
        args.rank,
        api=args.api,
        language=args.language,
        date_str=args.date,
        base_dir=args.base_dir
    )

    if success:
        print("[SUCCESS] åˆ†æå®Œæˆ")
    else:
        print("[ERROR] åˆ†æå¤±è´¥")
        sys.exit(1)

if __name__ == "__main__":
    main()
